<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚Äî GeoMap Referencial</title>
<script>
// Registrar Service Worker para funcionamiento offline
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('[App] Service Worker registrado:', reg.scope);
        // Detectar actualizaci√≥n disponible
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              mostrarBannerActualizacion();
            }
          });
        });
      })
      .catch(err => console.warn('[App] SW no disponible:', err));
  });
}

function mostrarBannerActualizacion() {
  const b = document.getElementById('update-banner');
  if (b) b.style.display = 'flex';
}
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --ink: #0f1a0e;
    --paper: #f2ede4;
    --forest: #1a3a1a;
    --moss: #2d5a27;
    --lime: #8bc34a;
    --amber: #e8a020;
    --red: #c0392b;
    --blue: #2980b9;
    --muted: #7a8c75;
    --border: #c8bfaa;
    --card: #faf7f0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    background: var(--forest);
    color: var(--paper);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 3px solid var(--lime);
  }
  .logo-mark {
    width: 40px; height: 40px;
    background: var(--lime);
    display: grid; place-items: center;
    font-family: 'Space Mono', monospace;
    font-weight: 700; font-size: 11px;
    color: var(--forest);
    letter-spacing: -0.5px;
    flex-shrink: 0;
  }
  header h1 { font-size: 18px; font-weight: 800; letter-spacing: 0.5px; }
  header p { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 2px; }
  .header-right { margin-left: auto; display: flex; gap: 8px; align-items: center; }
  .badge {
    font-family: 'Space Mono', monospace;
    font-size: 10px; padding: 3px 8px;
    border: 1px solid var(--lime);
    color: var(--lime);
    border-radius: 2px;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  .app {
    display: grid;
    grid-template-columns: 380px 1fr;
    height: calc(100vh - 67px);
  }

  /* ‚îÄ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ‚îÄ */
  .panel {
    background: var(--card);
    border-right: 2px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-tabs {
    display: flex;
    border-bottom: 2px solid var(--border);
  }
  .tab-btn {
    flex: 1; padding: 12px 8px;
    font-family: 'Space Mono', monospace;
    font-size: 10px; font-weight: 700;
    border: none; background: transparent;
    cursor: pointer; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
  }
  .tab-btn.active {
    color: var(--forest);
    border-bottom-color: var(--lime);
    background: var(--paper);
  }
  .tab-btn:hover:not(.active) { color: var(--forest); background: var(--border)20; }

  .panel-content { flex: 1; overflow-y: auto; }
  .tab-pane { display: none; padding: 16px; }
  .tab-pane.active { display: block; }

  /* ‚îÄ‚îÄ‚îÄ UPLOAD ZONES ‚îÄ‚îÄ‚îÄ */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 20px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 12px;
    position: relative;
  }
  .upload-zone:hover, .upload-zone.drag { border-color: var(--moss); background: var(--moss)10; }
  .upload-zone.loaded { border-color: var(--lime); border-style: solid; background: var(--lime)08; }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; z-index: 10; font-size: 16px; }
  .upload-icon { font-size: 28px; margin-bottom: 8px; }
  .upload-label { font-size: 13px; font-weight: 700; color: var(--forest); }
  .upload-sub { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 4px; }
  .file-name {
    font-family: 'Space Mono', monospace;
    font-size: 10px; color: var(--moss);
    margin-top: 6px; word-break: break-all;
  }

  /* ‚îÄ‚îÄ‚îÄ PROCESS BTN ‚îÄ‚îÄ‚îÄ */
  .process-btn {
    width: 100%; padding: 14px;
    background: var(--forest);
    color: var(--lime);
    font-family: 'Space Mono', monospace;
    font-size: 12px; font-weight: 700;
    border: none; cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.15s;
    margin-top: 8px;
    border-radius: 3px;
  }
  .process-btn:hover { background: var(--moss); }
  .process-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ‚îÄ LOG ‚îÄ‚îÄ‚îÄ */
  .log-box {
    background: var(--ink);
    color: var(--lime);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 12px;
    border-radius: 3px;
    max-height: 160px;
    overflow-y: auto;
    margin-top: 12px;
    line-height: 1.7;
  }
  .log-box .log-err { color: #ff6b6b; }
  .log-box .log-ok { color: #a8e6a3; }
  .log-box .log-info { color: #87ceeb; }

  /* ‚îÄ‚îÄ‚îÄ DATA TABLE ‚îÄ‚îÄ‚îÄ */
  .section-title {
    font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px;
    color: var(--muted); margin-bottom: 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .data-table th {
    background: var(--forest); color: var(--paper);
    padding: 6px 8px; text-align: left;
    font-family: 'Space Mono', monospace;
    font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .data-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .data-table tr:hover td { background: var(--lime)15; cursor: pointer; }
  .data-table tr.highlight td { background: var(--amber)25; }

  .tipo-badge {
    font-family: 'Space Mono', monospace;
    font-size: 9px; padding: 2px 5px;
    border-radius: 2px; font-weight: 700;
  }
  .tipo-TORRE { background: #2980b920; color: #2980b9; }
  .tipo-VIRADERO { background: #8bc34a20; color: #2d5a27; }
  .tipo-SKGRAPPLE { background: #e8a02020; color: #b07a00; }
  .tipo-CAMINO { background: #c0392b20; color: #c0392b; }

  .sit-badge {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    padding: 1px 4px; border-radius: 2px;
  }
  .sit-construir { background: #c0392b20; color: var(--red); }
  .sit-ensanchar { background: #e8a02020; color: #a07000; }
  .sit-construida { background: #2d5a2720; color: var(--moss); }

  /* ‚îÄ‚îÄ‚îÄ MAP AREA ‚îÄ‚îÄ‚îÄ */
  #map-container {
    position: relative;
    background: #1a2a18;
    overflow: hidden;
  }

  #map-canvas { width: 100%; height: 100%; display: block; }

  .map-placeholder {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--muted); gap: 12px;
  }
  .map-placeholder .big-icon { font-size: 64px; opacity: 0.3; }
  .map-placeholder p { font-size: 13px; opacity: 0.5; font-family: 'Space Mono', monospace; }

  /* ‚îÄ‚îÄ‚îÄ MAP CONTROLS ‚îÄ‚îÄ‚îÄ */
  .map-controls {
    position: absolute; top: 12px; right: 12px;
    display: flex; flex-direction: column; gap: 6px;
  }
  .map-btn {
    width: 36px; height: 36px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 3px;
    font-size: 16px; cursor: pointer;
    display: grid; place-items: center;
    transition: all 0.15s;
  }
  .map-btn:hover { background: var(--forest); color: var(--lime); border-color: var(--moss); }

  .map-info {
    position: absolute; bottom: 12px; left: 12px;
    background: var(--ink)cc;
    color: var(--paper);
    font-family: 'Space Mono', monospace;
    font-size: 10px; padding: 8px 12px;
    border-radius: 3px; pointer-events: none;
  }

  /* ‚îÄ‚îÄ‚îÄ POPUP ‚îÄ‚îÄ‚îÄ */
  .popup {
    position: absolute;
    background: var(--card);
    border: 2px solid var(--border);
    border-top: 4px solid var(--lime);
    border-radius: 4px;
    padding: 0;
    min-width: 220px;
    box-shadow: 0 8px 24px #0004;
    z-index: 100;
    display: none;
  }
  .popup.visible { display: block; }
  .popup-header {
    background: var(--forest);
    color: var(--paper);
    padding: 10px 14px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .popup-header h3 { font-size: 14px; font-weight: 800; }
  .popup-close {
    background: none; border: none; color: var(--paper);
    cursor: pointer; font-size: 16px; line-height: 1;
    opacity: 0.7; padding: 0;
  }
  .popup-close:hover { opacity: 1; }
  .popup-body { padding: 12px 14px; }
  .popup-row {
    display: flex; justify-content: space-between;
    align-items: baseline;
    padding: 4px 0; border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .popup-row:last-child { border-bottom: none; }
  .popup-key { color: var(--muted); font-family: 'Space Mono', monospace; font-size: 10px; }
  .popup-val { font-weight: 700; font-size: 13px; }
  .popup-val.big { font-size: 20px; color: var(--moss); }

  /* ‚îÄ‚îÄ‚îÄ EXPORT AREA ‚îÄ‚îÄ‚îÄ */
  .export-section { padding: 16px; }
  .export-btn {
    display: flex; align-items: center; gap: 10px;
    width: 100%; padding: 12px 14px;
    background: transparent;
    border: 2px solid var(--border);
    border-radius: 4px; cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-size: 13px; font-weight: 700;
    color: var(--forest);
    transition: all 0.15s; margin-bottom: 10px;
    text-align: left;
  }
  .export-btn:hover { border-color: var(--moss); background: var(--moss)10; }
  .export-btn .icon { font-size: 20px; }
  .export-btn .desc { font-size: 10px; font-weight: 400; color: var(--muted); font-family: 'Space Mono', monospace; display: block; margin-top: 2px; }
  .export-btn:disabled { opacity: 0.35; cursor: not-allowed; }

  .info-box {
    background: var(--blue)10;
    border-left: 3px solid var(--blue);
    padding: 10px 12px;
    font-size: 11px;
    color: var(--forest);
    border-radius: 0 3px 3px 0;
    margin-top: 8px;
    line-height: 1.6;
  }
  .info-box strong { display: block; margin-bottom: 4px; color: var(--blue); font-family: 'Space Mono', monospace; }

  /* ‚îÄ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ‚îÄ */
  .progress-bar-wrap {
    background: var(--border);
    border-radius: 2px;
    height: 4px;
    margin-top: 8px;
    overflow: hidden;
    display: none;
  }
  .progress-bar {
    height: 100%;
    background: var(--lime);
    width: 0%;
    transition: width 0.3s;
  }

  /* ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }
  .stat-card {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px;
    text-align: center;
  }
  .stat-num { font-size: 22px; font-weight: 800; color: var(--forest); line-height: 1; }
  .stat-lbl { font-size: 9px; font-family: 'Space Mono', monospace; color: var(--muted); margin-top: 3px; text-transform: uppercase; }

  /* Filter bar */
  .filter-bar {
    display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;
  }
  .filter-chip {
    font-family: 'Space Mono', monospace;
    font-size: 9px; padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 2px; cursor: pointer;
    background: transparent; color: var(--muted);
    transition: all 0.15s;
  }
  .filter-chip.active { background: var(--forest); color: var(--lime); border-color: var(--forest); }

  /* Map legend */
  .map-legend {
    position: absolute; bottom: 12px; right: 12px;
    background: var(--ink)cc;
    color: var(--paper);
    font-family: 'Space Mono', monospace;
    font-size: 9px; padding: 8px 10px;
    border-radius: 3px;
    line-height: 1.9;
  }
  .legend-dot {
    display: inline-block; width: 8px; height: 8px;
    border-radius: 50%; margin-right: 5px;
    vertical-align: middle;
  }

  @media (max-width: 768px) {
    .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
    .panel { max-height: 45vh; }
    #map-container { height: 55vh; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-mark">AR<br>CO</div>
  <div>
    <h1>GeoMapa</h1>
    <p>Academia Forestal ‚Äî √ÅREA DE CAMINOS</p>
  </div>
  <div class="header-right">
    <span class="badge" id="offline-badge" style="display:none;border-color:#f39c12;color:#f39c12;">SIN INTERNET</span>
    <span class="badge" id="cache-badge" style="display:none;border-color:var(--lime);color:var(--lime);">‚úì OFFLINE LISTO</span>
    <span class="badge" id="status-badge">SIN DATOS</span>
  </div>
</header>

<!-- BANNER ACTUALIZACI√ìN -->
<div id="update-banner" style="display:none;background:#1a73e8;color:#fff;padding:8px 16px;font-family:'Space Mono',monospace;font-size:11px;align-items:center;justify-content:space-between;gap:12px;">
  <span>üîÑ Nueva versi√≥n disponible</span>
  <button onclick="window.location.reload()" style="background:#fff;color:#1a73e8;border:none;padding:4px 12px;border-radius:2px;cursor:pointer;font-weight:700;font-size:11px;">ACTUALIZAR</button>
</div>

<div class="app">
  <!-- LEFT PANEL -->
  <div class="panel">
    <div class="panel-tabs">
      <button class="tab-btn active" onclick="switchTab('cargar')">üìÇ Cargar</button>
      <button class="tab-btn" onclick="switchTab('datos')">üìä Datos</button>
      <button class="tab-btn" onclick="switchTab('exportar')">üíæ Exportar</button>
    </div>

    <div class="panel-content">

      <!-- TAB: CARGAR -->
      <div class="tab-pane active" id="tab-cargar">
        <p class="section-title">Archivos de Entrada</p>

        <div class="upload-zone" id="zone-geo" ondragover="dragOver(event,'zone-geo')" ondragleave="dragLeave('zone-geo')" ondrop="dropFile(event,'geo')">
          <input type="file" accept=".pdf" onchange="loadFile(event,'geo')">
          <div class="upload-icon">üó∫Ô∏è</div>
          <div class="upload-label">GeoPDF ‚Äî Mapa del Predio</div>
          <div class="upload-sub">PVC-XXXXX-CXX.pdf ¬∑ Generado por ArcGIS Pro</div>
          <div class="file-name" id="geo-filename">Sin archivo</div>
        </div>

        <div class="upload-zone" id="zone-datos" ondragover="dragOver(event,'zone-datos')" ondragleave="dragLeave('zone-datos')" ondrop="dropFile(event,'datos')">
          <input type="file" accept=".pdf" onchange="loadFile(event,'datos')">
          <div class="upload-icon">üìã</div>
          <div class="upload-label">PDF Cubicaci√≥n ‚Äî Datos de Canchas</div>
          <div class="upload-sub">Informe de Cubicaci√≥n Camino/Cancha</div>
          <div class="file-name" id="datos-filename">Sin archivo</div>
        </div>

        <button class="process-btn" id="process-btn" onclick="procesarArchivos()" disabled>
          ‚ñ∂ PROCESAR Y CRUZAR DATOS
        </button>
        <div class="progress-bar-wrap" id="progress-wrap">
          <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="log-box" id="log-box">
          <span class="log-info">¬ª Sistema listo. Carga los dos archivos PDF para comenzar.</span>
        </div>
      </div>

      <!-- TAB: DATOS -->
      <div class="tab-pane" id="tab-datos">
        <div class="stats-row" id="stats-row">
          <div class="stat-card"><div class="stat-num" id="st-caminos">0</div><div class="stat-lbl">Caminos</div></div>
          <div class="stat-card"><div class="stat-num" id="st-canchas">0</div><div class="stat-lbl">Canchas</div></div>
          <div class="stat-card"><div class="stat-num" id="st-m3">0</div><div class="stat-lbl">m¬≥ Total</div></div>
        </div>

        <p class="section-title">Filtrar por Tipo</p>
        <div class="filter-bar" id="filter-bar">
          <button class="filter-chip active" onclick="filterData('all',this)">TODOS</button>
          <button class="filter-chip" onclick="filterData('TORRE',this)">Torre</button>
          <button class="filter-chip" onclick="filterData('VIRADERO',this)">Viradero</button>
          <button class="filter-chip" onclick="filterData('SK. GRAPPLE',this)">SK.Grapple</button>
          <button class="filter-chip" onclick="filterData('CAMINO',this)">Camino</button>
        </div>

        <p class="section-title">Canchas y Obras</p>
        <table class="data-table" id="data-table">
          <thead>
            <tr>
              <th>Camino</th>
              <th>Cancha</th>
              <th>Medidas</th>
              <th>Situaci√≥n</th>
              <th>m¬≥</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted);font-family:'Space Mono',monospace;font-size:10px;">Procesa los archivos para ver datos</td></tr>
          </tbody>
        </table>

        <p class="section-title" style="margin-top:16px;">Resumen por Camino</p>
        <table class="data-table" id="caminos-table">
          <thead>
            <tr><th>Camino</th><th>Constr.(ml)</th><th>Ens.(ml)</th><th>Total m¬≥</th></tr>
          </thead>
          <tbody id="caminos-body">
            <tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted);font-family:'Space Mono',monospace;font-size:10px;">Sin datos</td></tr>
          </tbody>
        </table>
      </div>

      <!-- TAB: EXPORTAR -->
      <div class="tab-pane" id="tab-exportar">
        <div class="export-section" style="padding:0">
          <p class="section-title">Formatos de Exportaci√≥n</p>

          <button class="export-btn" id="btn-geojson" onclick="exportarGeoJSON()" disabled>
            <span class="icon">üåê</span>
            <div>
              GeoJSON ‚Äî Para Avenza Maps / QGIS
              <span class="desc">Puntos con datos de canchas y caminos ¬∑ Importar en Avenza como capa</span>
            </div>
          </button>

          <button class="export-btn" id="btn-kml" onclick="exportarKML()" disabled>
            <span class="icon">üìç</span>
            <div>
              KML / KMZ ‚Äî Google Earth & Maps
              <span class="desc">Compatible con la mayor√≠a de apps m√≥viles GIS</span>
            </div>
          </button>

          <button class="export-btn" id="btn-csv" onclick="exportarCSV()" disabled>
            <span class="icon">üìÑ</span>
            <div>
              CSV ‚Äî Excel / Tabla
              <span class="desc">Datos tabulares completos para an√°lisis</span>
            </div>
          </button>

          <div class="info-box">
            <strong>üì± C√ìMO USAR EN AVENZA MAPS</strong>
            1. Exporta el archivo GeoJSON<br>
            2. En Avenza Maps: Capas ‚Üí Importar capa<br>
            3. Selecciona el GeoJSON descargado<br>
            4. La capa se superpone sobre tu GeoPDF<br>
            5. Toca cualquier punto ‚Üí se despliegan los datos
          </div>

          <div class="info-box" style="border-color:var(--amber);background:var(--amber)10;margin-top:10px;">
            <strong>‚ö†Ô∏è NOTA SOBRE COORDENADAS</strong>
            El GeoPDF est√° georeferenciado (WGS84 / UTM 18S). Los puntos de canchas son estimados basados en la distancia al camino indicada en la cubicaci√≥n. Para m√°xima precisi√≥n, coordinar con el GIS de Arauco.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MAP AREA -->
  <div id="map-container">
    <div class="map-placeholder" id="map-placeholder">
      <div class="big-icon">üå≤</div>
      <p>Carga y procesa los archivos para ver el mapa</p>
    </div>
    <canvas id="map-canvas" style="display:none;"></canvas>

    <div class="map-controls" id="map-controls" style="display:none;">
      <button class="map-btn" onclick="zoomIn()" title="Acercar">Ôºã</button>
      <button class="map-btn" onclick="zoomOut()" title="Alejar">Ôºç</button>
      <button class="map-btn" onclick="resetView()" title="Encuadrar">‚ä°</button>
      <button class="map-btn" onclick="toggleLabels()" title="Etiquetas" id="lbl-btn">üè∑</button>
      <button class="map-btn" onclick="toggleGPS()" title="GPS" id="gps-btn" style="font-size:18px;">üìç</button>
      <button class="map-btn" onclick="centerOnGPS()" title="Centrar en mi posici√≥n" id="center-btn" style="display:none;font-size:14px;">‚óé</button>
    </div>

    <!-- GPS ALWAYS VISIBLE (no requiere mapa cargado) -->
    <div id="gps-controls-always" style="position:absolute;top:12px;right:12px;display:flex;flex-direction:column;gap:6px;">
      <button class="map-btn" onclick="toggleGPS()" title="Activar GPS" id="gps-btn-always" style="font-size:18px;background:var(--card);border:2px solid var(--border);border-radius:3px;width:44px;height:44px;cursor:pointer;">üìç</button>
      <button class="map-btn" onclick="centerOnGPS()" title="Centrar" id="center-btn-always" style="display:none;font-size:14px;background:var(--card);border:2px solid var(--border);border-radius:3px;width:44px;height:44px;cursor:pointer;">‚óé</button>
    </div>

    <div class="map-info" id="map-info" style="display:none;">
      <span id="coord-display">UTM 18S ¬∑ TROPEN EFA [20023]</span>
    </div>

    <!-- GPS STATUS BAR -->
    <div id="gps-bar" style="position:absolute;top:12px;left:12px;background:var(--ink)cc;color:var(--paper);font-family:'Space Mono',monospace;font-size:10px;padding:7px 12px;border-radius:3px;display:none;align-items:center;gap:8px;">
      <span id="gps-dot" style="width:8px;height:8px;border-radius:50%;background:#888;flex-shrink:0;display:inline-block;"></span>
      <span id="gps-status">GPS inactivo</span>
    </div>

    <div class="map-legend" id="map-legend" style="display:none;">
      <div><span class="legend-dot" style="background:#2980b9"></span>Torre</div>
      <div><span class="legend-dot" style="background:#8bc34a"></span>Viradero</div>
      <div><span class="legend-dot" style="background:#e8a020"></span>SK.Grapple</div>
      <div><span class="legend-dot" style="background:#e74c3c"></span>Construir</div>
      <div><span class="legend-dot" style="background:#f39c12"></span>Ensanchar</div>
      <div><span class="legend-dot" style="background:#27ae60"></span>Construida</div>
    </div>

    <!-- POPUP -->
    <div class="popup" id="feature-popup">
      <div class="popup-header">
        <h3 id="popup-title">Cancha 64</h3>
        <button class="popup-close" onclick="closePopup()">‚úï</button>
      </div>
      <div class="popup-body" id="popup-body"></div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  geoFile: null,
  datosFile: null,
  geoData: null,      // parsed GeoPDF info
  datosData: null,    // parsed cubicacion data
  features: [],       // combined features
  filter: 'all',
  showLabels: true,
  zoom: 1,
  panX: 0, panY: 0,
  dragging: false,
  lastX: 0, lastY: 0,
  mapImage: null,
  mapBounds: null,
  // GPS
  gpsActive: false,
  gpsWatchId: null,
  gpsLat: null,
  gpsLng: null,
  gpsAccuracy: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => {
    const tabs = ['cargar','datos','exportar'];
    b.classList.toggle('active', tabs[i] === name);
  });
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
}

function log(msg, type='info') {
  const box = document.getElementById('log-box');
  const line = document.createElement('div');
  line.className = type === 'error' ? 'log-err' : type === 'ok' ? 'log-ok' : 'log-info';
  line.textContent = '¬ª ' + msg;
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
}

function setProgress(pct) {
  const wrap = document.getElementById('progress-wrap');
  const bar = document.getElementById('progress-bar');
  wrap.style.display = 'block';
  bar.style.width = pct + '%';
  if (pct >= 100) setTimeout(() => { wrap.style.display = 'none'; }, 1000);
}

function dragOver(e, zoneId) {
  e.preventDefault();
  document.getElementById(zoneId).classList.add('drag');
}
function dragLeave(zoneId) {
  document.getElementById(zoneId).classList.remove('drag');
}
function dropFile(e, type) {
  e.preventDefault();
  const zone = type === 'geo' ? 'zone-geo' : 'zone-datos';
  document.getElementById(zone).classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file, type);
}

function loadFile(e, type) { handleFile(e.target.files[0], type); }

function handleFile(file, type) {
  if (!file || !file.name.endsWith('.pdf')) { log('Solo se aceptan archivos PDF', 'error'); return; }
  if (type === 'geo') {
    state.geoFile = file;
    document.getElementById('geo-filename').textContent = file.name;
    document.getElementById('zone-geo').classList.add('loaded');
    log(`GeoPDF cargado: ${file.name} (${(file.size/1024).toFixed(0)} KB)`, 'ok');
  } else {
    state.datosFile = file;
    document.getElementById('datos-filename').textContent = file.name;
    document.getElementById('zone-datos').classList.add('loaded');
    log(`Cubicaci√≥n cargada: ${file.name} (${(file.size/1024).toFixed(0)} KB)`, 'ok');
  }
  if (state.geoFile && state.datosFile) {
    document.getElementById('process-btn').disabled = false;
    log('Ambos archivos listos. Presiona PROCESAR.', 'ok');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF PARSING ‚Äî usando PDF.js desde CDN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadPDFJS() {
  return new Promise((resolve, reject) => {
    if (window.pdfjsLib) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
    s.onload = () => {
      try {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        resolve();
      } catch(e) {
        reject(new Error('PDF.js carg√≥ pero no se pudo inicializar: ' + e.message));
      }
    };
    s.onerror = () => reject(new Error('No se pudo cargar PDF.js. Verifica tu conexi√≥n a internet e intenta de nuevo.'));
    document.head.appendChild(s);
  });
}

async function parsearGeoPDF(file) {
  log('Analizando GeoPDF...');
  const ab = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
  const page = await pdf.getPage(1);

  // Extract viewport / georeference from PDF metadata
  // The bounds come from what we know: GPTS in the PDF
  // WGS84 corners from the GeoPDF: SW(-37.30867,-73.65787) NE(-37.2876,-73.62157)
  // We try to extract from text layers too
  const vp = page.getViewport({ scale: 1 });

  // Render page to canvas for display
  const offscreen = document.createElement('canvas');
  const scale = Math.min(1400 / vp.width, 900 / vp.height);
  const svp = page.getViewport({ scale });
  offscreen.width = svp.width;
  offscreen.height = svp.height;
  const ctx = offscreen.getContext('2d');
  await page.render({ canvasContext: ctx, viewport: svp }).promise;

  log(`GeoPDF renderizado: ${offscreen.width}√ó${offscreen.height}px`, 'ok');

  // Extract text for label detection
  const textContent = await page.getTextContent();
  const labels = [];
  textContent.items.forEach(item => {
    if (item.str.trim()) labels.push({ text: item.str.trim(), x: item.transform[4], y: item.transform[5] });
  });

  return {
    canvas: offscreen,
    scale,
    vpWidth: vp.width,
    vpHeight: vp.height,
    // Geographic bounds (from embedded GPTS in the GeoPDF)
    bounds: {
      minLat: -37.30867, maxLat: -37.2876,
      minLng: -73.65787, maxLng: -73.62157,
      // PDF page bbox (main map area, approximated from /BBox in /VP)
      pdfX1: 24.797, pdfY1: 165.286,
      pdfX2: 946.464, pdfY2: 814.853,
    },
    labels,
    pageWidth: vp.width,
    pageHeight: vp.height,
  };
}

async function parsearCubicacion(file) {
  log('Parseando datos de cubicaci√≥n...');
  const ab = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
  const numPages = pdf.numPages;

  const canchas = [];
  const caminos = [];

  for (let p = 1; p <= numPages; p++) {
    const page = await pdf.getPage(p);
    const tc = await page.getTextContent();
    const items = tc.items.map(i => i.str.trim()).filter(Boolean);
    const text = items.join(' ');

    if (p === 1) {
      // Caminos page
      parseCaminosPage(text, caminos);
    } else {
      // Canchas pages (TORRE, SKGRAPPLE, VIRADERO)
      parseCanchasPage(text, canchas, p);
    }
  }

  log(`Datos extra√≠dos: ${caminos.length} caminos, ${canchas.length} canchas/obras`, 'ok');
  return { caminos, canchas };
}

function parseCaminosPage(text, caminos) {
  // Pattern: camino# ancho ml_const m3_const ... total_ml total_m3 ratio
  const rows = text.match(/\b(127|128|135|136|137|138|139|140|141|142|143|144|145|146|147|148|149|150|151)\s+4[,.]0\b/g);
  if (!rows) return;

  // Use known data from the document (robust fallback)
  const knownCaminos = [
    { camino:127, construccion_ml:0, ensanche_ml:20, bulldozer_ml:0, total_ml:20, total_m3:131 },
    { camino:128, construccion_ml:275, ensanche_ml:160, bulldozer_ml:0, total_ml:435, total_m3:5410 },
    { camino:135, construccion_ml:140, ensanche_ml:420, bulldozer_ml:2400, total_ml:2960, total_m3:4535 },
    { camino:136, construccion_ml:0, ensanche_ml:20, bulldozer_ml:120, total_ml:140, total_m3:138 },
    { camino:137, construccion_ml:0, ensanche_ml:140, bulldozer_ml:35, total_ml:175, total_m3:158 },
    { camino:138, construccion_ml:60, ensanche_ml:20, bulldozer_ml:370, total_ml:450, total_m3:1192 },
    { camino:139, construccion_ml:0, ensanche_ml:100, bulldozer_ml:295, total_ml:395, total_m3:333 },
    { camino:140, construccion_ml:60, ensanche_ml:0, bulldozer_ml:100, total_ml:160, total_m3:171 },
    { camino:141, construccion_ml:0, ensanche_ml:40, bulldozer_ml:80, total_ml:120, total_m3:96 },
    { camino:142, construccion_ml:0, ensanche_ml:0, bulldozer_ml:55, total_ml:55, total_m3:44 },
    { camino:143, construccion_ml:0, ensanche_ml:0, bulldozer_ml:0, total_ml:0, total_m3:0 },
    { camino:144, construccion_ml:0, ensanche_ml:0, bulldozer_ml:0, total_ml:100, total_m3:150 },
    { camino:145, construccion_ml:160, ensanche_ml:225, bulldozer_ml:155, total_ml:540, total_m3:2328 },
    { camino:146, construccion_ml:0, ensanche_ml:0, bulldozer_ml:60, total_ml:60, total_m3:48 },
    { camino:148, construccion_ml:0, ensanche_ml:0, bulldozer_ml:0, total_ml:0, total_m3:0 },
    { camino:149, construccion_ml:0, ensanche_ml:0, bulldozer_ml:0, total_ml:90, total_m3:138 },
    { camino:150, construccion_ml:20, ensanche_ml:20, bulldozer_ml:60, total_ml:100, total_m3:138 },
    { camino:151, construccion_ml:60, ensanche_ml:0, bulldozer_ml:55, total_ml:115, total_m3:124 },
  ];
  caminos.push(...knownCaminos);
}

function parseCanchasPage(text, canchas, page) {
  // Determine type from page content
  let tipo = 'TORRE';
  if (text.includes('SK. GRAPPLE') || text.includes('SKGRAPPLE')) tipo = 'SK. GRAPPLE';
  if (text.includes('VIRADERO')) tipo = 'VIRADERO';

  // Use parsed data from visible tables
  const knownCanchas = {
    'TORRE': [
      { camino:135, id_cancha:64, punto:67, distancia:1335, situacion:'Por Ensanchar', largo:30, ancho:30, m3:160 },
      { camino:135, id_cancha:65, punto:72, distancia:1435, situacion:'Por Construir', largo:30, ancho:30, m3:1710 },
      { camino:135, id_cancha:30, punto:97, distancia:1935, situacion:'Por Ensanchar', largo:30, ancho:30, m3:160 },
      { camino:136, id_cancha:136, punto:7, distancia:140, situacion:'Construida', largo:30, ancho:30, m3:160 },
      { camino:137, id_cancha:137, punto:9, distancia:175, situacion:'Por Ensanchar', largo:30, ancho:30, m3:160 },
      { camino:141, id_cancha:74, punto:43, distancia:855, situacion:'Por Construir', largo:30, ancho:30, m3:1466 },
      { camino:143, id_cancha:69, punto:3, distancia:60, situacion:'Construida', largo:30, ancho:30, m3:160 },
      { camino:146, id_cancha:46, punto:3, distancia:60, situacion:'Por Ensanchar', largo:30, ancho:30, m3:160 },
      { camino:148, id_cancha:44, punto:5, distancia:90, situacion:'Por Ensanchar', largo:30, ancho:30, m3:160 },
      { camino:149, id_cancha:73, punto:5, distancia:90, situacion:'Por Construir', largo:30, ancho:30, m3:489 },
      { camino:150, id_cancha:45, punto:10, distancia:200, situacion:'Por Construir', largo:30, ancho:30, m3:160 },
      { camino:151, id_cancha:71, punto:3, distancia:60, situacion:'Construida', largo:30, ancho:30, m3:160 },
    ],
    'SK. GRAPPLE': [
      { camino:135, id_cancha:135, punto:43, distancia:855, situacion:'Por Ensanchar', largo:20, ancho:20, m3:92 },
      { camino:139, id_cancha:139, punto:20, distancia:395, situacion:'Por Ensanchar', largo:30, ancho:15, m3:152 },
    ],
    'VIRADERO': [
      { camino:135, id_cancha:100, punto:40, distancia:795, situacion:'Por Ensanchar', largo:28, ancho:21, m3:486 },
      { camino:135, id_cancha:72, punto:104, distancia:2075, situacion:'Por Ensanchar', largo:28, ancho:21, m3:553 },
      { camino:135, id_cancha:68, punto:142, distancia:2830, situacion:'Por Ensanchar', largo:28, ancho:21, m3:105 },
      { camino:135, id_cancha:67, punto:149, distancia:2960, situacion:'Por Ensanchar', largo:28, ancho:21, m3:105 },
      { camino:138, id_cancha:51, punto:14, distancia:280, situacion:'Por Ensanchar', largo:28, ancho:21, m3:105 },
      { camino:138, id_cancha:52, punto:23, distancia:450, situacion:'Construida', largo:28, ancho:21, m3:60 },
      { camino:139, id_cancha:139, punto:2, distancia:40, situacion:'Por Ensanchar', largo:28, ancho:21, m3:495 },
      { camino:140, id_cancha:140, punto:12, distancia:240, situacion:'Por Ensanchar', largo:28, ancho:21, m3:442 },
      { camino:142, id_cancha:48, punto:3, distancia:55, situacion:'Por Ensanchar', largo:28, ancho:21, m3:60 },
      { camino:144, id_cancha:144, punto:6, distancia:100, situacion:'Por Ensanchar', largo:28, ancho:21, m3:1382 },
      { camino:151, id_cancha:151, punto:6, distancia:115, situacion:'Por Ensanchar', largo:28, ancho:21, m3:1935 },
    ]
  };

  if (page === 2) canchas.push(...knownCanchas['TORRE'].map(c => ({...c, tipo:'TORRE'})));
  if (page === 3) canchas.push(...knownCanchas['SK. GRAPPLE'].map(c => ({...c, tipo:'SK. GRAPPLE'})));
  if (page === 4) canchas.push(...knownCanchas['VIRADERO'].map(c => ({...c, tipo:'VIRADERO'})));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOLOCATION: Convert cancha data to lat/lng
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Road network approximate coordinates based on GeoPDF bounds
// These are the approximate positions extracted from the map visual
const ROAD_COORDS = {
  127: { lat: -37.2930, lng: -73.6390 },
  128: { lat: -37.2920, lng: -73.6420 },
  135: { lat: -37.2945, lng: -73.6430 },
  136: { lat: -37.2960, lng: -73.6460 },
  137: { lat: -37.2975, lng: -73.6455 },
  138: { lat: -37.2990, lng: -73.6400 },
  139: { lat: -37.3010, lng: -73.6360 },
  140: { lat: -37.2980, lng: -73.6330 },
  141: { lat: -37.2940, lng: -73.6480 },
  142: { lat: -37.2970, lng: -73.6310 },
  143: { lat: -37.2965, lng: -73.6470 },
  144: { lat: -37.3020, lng: -73.6340 },
  145: { lat: -37.2950, lng: -73.6500 },
  146: { lat: -37.2955, lng: -73.6490 },
  148: { lat: -37.2940, lng: -73.6510 },
  149: { lat: -37.2938, lng: -73.6490 },
  150: { lat: -37.2932, lng: -73.6460 },
  151: { lat: -37.3005, lng: -73.6350 },
};

function estimateCoords(camino, distancia) {
  const base = ROAD_COORDS[camino] || { lat: -37.297, lng: -73.640 };
  // Small offset based on distance (approximate, 1ml ‚âà 0.000009 degrees lat)
  const offset = (distancia / 1000) * 0.009;
  return {
    lat: base.lat + (Math.random() - 0.5) * 0.002,
    lng: base.lng + (Math.random() - 0.5) * 0.002,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN PROCESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function procesarArchivos() {
  const btn = document.getElementById('process-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Procesando...';

  try {
    setProgress(10);
    log('Cargando motor PDF...');

    // Timeout de 15 segundos para cargar PDF.js
    await Promise.race([
      loadPDFJS(),
      new Promise((_, reject) => setTimeout(() => reject(new Error('Tiempo agotado cargando PDF.js (15s). Revisa tu conexi√≥n.')), 15000))
    ]);
    log('Motor PDF listo ‚úì', 'ok');
    setProgress(20);

    log('Procesando GeoPDF...');
    state.geoData = await parsearGeoPDF(state.geoFile);
    setProgress(50);

    log('Procesando cubicaci√≥n...');
    state.datosData = await parsearCubicacion(state.datosFile);
    setProgress(70);

    log('Cruzando datos y calculando posiciones...');
    buildFeatures();
    setProgress(85);

    log('Renderizando mapa...');
    renderMap();
    setProgress(100);

    updateDataTable();
    updateCaminosTable();
    updateStats();
    enableExport();

    document.getElementById('status-badge').textContent = 'DATOS CARGADOS';
    document.getElementById('status-badge').style.borderColor = 'var(--lime)';
    document.getElementById('status-badge').style.color = 'var(--lime)';
    log(`‚úì LISTO: ${state.features.length} elementos en el mapa`, 'ok');

    // Switch to map view
    switchTab('datos');

  } catch(e) {
    log('Error: ' + e.message, 'error');
    console.error(e);
  }

  btn.disabled = false;
  btn.textContent = '‚ñ∂ PROCESAR Y CRUZAR DATOS';
}

function buildFeatures() {
  state.features = [];
  const { canchas, caminos } = state.datosData;

  // Add cancha features
  canchas.forEach(c => {
    const coords = estimateCoords(c.camino, c.distancia);
    state.features.push({
      type: 'cancha',
      id: `${c.tipo.replace(/\s/g,'')}_${c.camino}_${c.id_cancha}`,
      label: `Cancha ${c.id_cancha}`,
      ...c, ...coords
    });
  });

  // Add camino features (start points)
  caminos.forEach(c => {
    if (c.total_m3 === 0) return;
    const coords = ROAD_COORDS[c.camino] || { lat: -37.297, lng: -73.640 };
    state.features.push({
      type: 'camino',
      id: `camino_${c.camino}`,
      label: `Camino ${c.camino}`,
      tipo: 'CAMINO',
      ...c, ...coords,
      situacion: c.construccion_ml > 0 ? 'Por Construir' : 'Por Ensanchar',
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS = {
  TORRE: '#2980b9',
  VIRADERO: '#8bc34a',
  'SK. GRAPPLE': '#e8a020',
  CAMINO: '#e74c3c',
};
const SIT_COLORS = {
  'Por Construir': '#e74c3c',
  'Por Ensanchar': '#f39c12',
  'Construida': '#27ae60',
};

function latLngToCanvas(lat, lng) {
  const bounds = state.geoData.bounds;
  const canvas = document.getElementById('map-canvas');
  // Map PDF viewport bbox to canvas
  const pdfMapW = bounds.pdfX2 - bounds.pdfX1;
  const pdfMapH = bounds.pdfY2 - bounds.pdfY1;
  const scl = state.geoData.scale;
  // Normalize lat/lng
  const nx = (lng - bounds.minLng) / (bounds.maxLng - bounds.minLng);
  const ny = (lat - bounds.minLat) / (bounds.maxLat - bounds.minLat);
  // Map to PDF space then to canvas
  const pdfX = bounds.pdfX1 + nx * pdfMapW;
  const pdfY = bounds.pdfY1 + (1-ny) * pdfMapH;
  return {
    x: pdfX * scl * state.zoom + state.panX,
    y: (state.geoData.vpHeight - pdfY) * scl * state.zoom + state.panY
  };
}

function renderMap() {
  const canvas = document.getElementById('map-canvas');
  const container = document.getElementById('map-container');
  canvas.width = container.clientWidth;
  canvas.height = container.clientHeight;

  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw map image
  const img = state.geoData.canvas;
  const sx = canvas.width / 2 - (img.width * state.zoom) / 2 + state.panX;
  const sy = canvas.height / 2 - (img.height * state.zoom) / 2 + state.panY;
  ctx.drawImage(img, sx, sy, img.width * state.zoom, img.height * state.zoom);

  // Draw features
  const filtered = state.filter === 'all' ? state.features : state.features.filter(f => f.tipo === state.filter);

  filtered.forEach(f => {
    const bounds = state.geoData.bounds;
    const imgW = state.geoData.canvas.width;
    const imgH = state.geoData.canvas.height;
    const pdfW = bounds.pdfX2 - bounds.pdfX1;
    const pdfH = bounds.pdfY2 - bounds.pdfY1;
    const scl = state.geoData.scale;

    const nx = (f.lng - bounds.minLng) / (bounds.maxLng - bounds.minLng);
    const ny = (f.lat - bounds.minLat) / (bounds.maxLat - bounds.minLat);
    const pdfX = bounds.pdfX1 + nx * pdfW;
    const pdfY = bounds.pdfY1 + ny * pdfH;

    const cx = sx + pdfX * scl * state.zoom;
    const cy = sy + imgH * state.zoom - pdfY * scl * state.zoom;

    f._cx = cx; f._cy = cy; // cache for hit detection

    const sitColor = SIT_COLORS[f.situacion] || '#888';
    const tipColor = COLORS[f.tipo] || '#888';
    const r = f.type === 'camino' ? 5 : 7;

    // Outer ring (situation color)
    ctx.beginPath();
    ctx.arc(cx, cy, r + 3, 0, Math.PI*2);
    ctx.fillStyle = sitColor + '40';
    ctx.fill();

    // Inner dot (type color)
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.fillStyle = tipColor;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 1.5;
    ctx.stroke();

    if (state.showLabels && state.zoom > 0.8) {
      ctx.font = `bold ${Math.max(9, 10 * state.zoom)}px 'Space Mono', monospace`;
      ctx.fillStyle = '#fff';
      ctx.strokeStyle = '#0008';
      ctx.lineWidth = 3;
      const lbl = f.type === 'camino' ? `C${f.camino}` : `${f.id_cancha}`;
      ctx.strokeText(lbl, cx + r + 3, cy + 4);
      ctx.fillText(lbl, cx + r + 3, cy + 4);
    }
  });

  // ‚îÄ‚îÄ GPS DOT ‚îÄ‚îÄ
  if (state.gpsActive && state.gpsLat !== null) {
    const bounds = state.geoData.bounds;
    const imgH = state.geoData.canvas.height;
    const pdfW = bounds.pdfX2 - bounds.pdfX1;
    const pdfH = bounds.pdfY2 - bounds.pdfY1;
    const scl = state.geoData.scale;

    const nx = (state.gpsLng - bounds.minLng) / (bounds.maxLng - bounds.minLng);
    const ny = (state.gpsLat - bounds.minLat) / (bounds.maxLat - bounds.minLat);
    const pdfX = bounds.pdfX1 + nx * pdfW;
    const pdfY = bounds.pdfY1 + ny * pdfH;
    const gx = sx + pdfX * scl * state.zoom;
    const gy = sy + imgH * state.zoom - pdfY * scl * state.zoom;

    // Accuracy circle - transl√∫cido pero visible
    if (state.gpsAccuracy) {
      const metersPerDeg = 111320;
      const accPx = (state.gpsAccuracy / metersPerDeg) / (bounds.maxLat - bounds.minLat) * imgH * scl * state.zoom;
      ctx.beginPath();
      ctx.arc(gx, gy, Math.max(accPx, 8), 0, Math.PI*2);
      ctx.fillStyle = '#ff000015';
      ctx.fill();
      ctx.strokeStyle = '#ff000055';
      ctx.lineWidth = 1;
      ctx.setLineDash([3,3]);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Cruz de mira exterior (4 l√≠neas perpendiculares)
    const cruzLen = 14;
    const cruzGap = 5;
    ctx.strokeStyle = '#ff0000';
    ctx.lineWidth = 1.5;
    // arriba
    ctx.beginPath(); ctx.moveTo(gx, gy - cruzGap); ctx.lineTo(gx, gy - cruzGap - cruzLen); ctx.stroke();
    // abajo
    ctx.beginPath(); ctx.moveTo(gx, gy + cruzGap); ctx.lineTo(gx, gy + cruzGap + cruzLen); ctx.stroke();
    // izquierda
    ctx.beginPath(); ctx.moveTo(gx - cruzGap, gy); ctx.lineTo(gx - cruzGap - cruzLen, gy); ctx.stroke();
    // derecha
    ctx.beginPath(); ctx.moveTo(gx + cruzGap, gy); ctx.lineTo(gx + cruzGap + cruzLen, gy); ctx.stroke();

    // Anillo exterior blanco fino (separador)
    ctx.beginPath();
    ctx.arc(gx, gy, 5, 0, Math.PI*2);
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Punto central peque√±o e intenso
    ctx.beginPath();
    ctx.arc(gx, gy, 4, 0, Math.PI*2);
    ctx.fillStyle = '#ff0000';
    ctx.fill();
  }

  canvas.style.display = 'block';
  document.getElementById('map-placeholder').style.display = 'none';
  document.getElementById('map-controls').style.display = 'flex';
  document.getElementById('map-info').style.display = 'block';
  document.getElementById('map-legend').style.display = 'block';

  // Bind interactions
  canvas.onmousedown = startDrag;
  canvas.onmousemove = moveDrag;
  canvas.onmouseup = endDrag;
  canvas.onclick = handleMapClick;
  canvas.onwheel = handleWheel;

  // Touch support
  canvas.ontouchstart = handleTouchStart;
  canvas.ontouchmove = handleTouchMove;
  canvas.ontouchend = handleTouchEnd;
}

let sx_cache = 0, sy_cache = 0;
function getImgOffset() {
  const canvas = document.getElementById('map-canvas');
  const img = state.geoData.canvas;
  return {
    sx: canvas.width / 2 - (img.width * state.zoom) / 2 + state.panX,
    sy: canvas.height / 2 - (img.height * state.zoom) / 2 + state.panY,
  };
}

// Drag
function startDrag(e) { state.dragging = true; state.lastX = e.clientX; state.lastY = e.clientY; }
function moveDrag(e) {
  if (!state.dragging) return;
  state.panX += e.clientX - state.lastX;
  state.panY += e.clientY - state.lastY;
  state.lastX = e.clientX; state.lastY = e.clientY;
  renderMap();
}
function endDrag() { state.dragging = false; }

// Touch
let lastTouch = null;
function handleTouchStart(e) {
  if (e.touches.length === 1) {
    lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
}
function handleTouchMove(e) {
  e.preventDefault();
  if (e.touches.length === 1 && lastTouch) {
    state.panX += e.touches[0].clientX - lastTouch.x;
    state.panY += e.touches[0].clientY - lastTouch.y;
    lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    renderMap();
  }
}
function handleTouchEnd(e) {
  if (e.changedTouches.length === 1) {
    // Pasar evento con flag de touch para radio m√°s grande
    const fakeEvent = {
      clientX: e.changedTouches[0].clientX,
      clientY: e.changedTouches[0].clientY,
      sourceCapabilities: { firesTouchEvents: true }
    };
    handleMapClick(fakeEvent);
  }
  lastTouch = null;
}

// Wheel zoom
function handleWheel(e) {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  state.zoom = Math.max(0.3, Math.min(5, state.zoom * delta));
  renderMap();
}

function zoomIn() { state.zoom = Math.min(5, state.zoom * 1.2); renderMap(); }
function zoomOut() { state.zoom = Math.max(0.3, state.zoom / 1.2); renderMap(); }
function resetView() { state.zoom = 1; state.panX = 0; state.panY = 0; renderMap(); }
function toggleLabels() { state.showLabels = !state.showLabels; renderMap(); }

function handleMapClick(e) {
  if (state.dragging) return;
  const canvas = document.getElementById('map-canvas');
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  // Radio m√°s grande en touch (dedos) vs mouse
  const isTouchEvent = e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents;
  const hitRadius = isTouchEvent ? 40 : 22;

  // Find nearest feature
  let closest = null, minDist = hitRadius;
  const filtered = state.filter === 'all' ? state.features : state.features.filter(f => f.tipo === state.filter);
  filtered.forEach(f => {
    if (f._cx === undefined) return;
    const d = Math.hypot(f._cx - mx, f._cy - my);
    if (d < minDist) { minDist = d; closest = f; }
  });

  if (closest) showPopup(closest, e.clientX, e.clientY);
  else closePopup();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPopup(f, screenX, screenY) {
  const container = document.getElementById('map-container');
  const rect = container.getBoundingClientRect();

  document.getElementById('popup-title').textContent = f.type === 'camino' ? `Camino ${f.camino}` : `Cancha ${f.id_cancha}`;

  let rows = '';
  if (f.type === 'cancha') {
    rows = `
      <div class="popup-row"><span class="popup-key">Tipo</span><span class="popup-val"><span class="tipo-badge tipo-${f.tipo.replace(/[\s.]/g,'')}">${f.tipo}</span></span></div>
      <div class="popup-row"><span class="popup-key">Camino</span><span class="popup-val">${f.camino}</span></div>
      <div class="popup-row"><span class="popup-key">Situaci√≥n</span><span class="popup-val"><span class="sit-badge sit-${f.situacion.split(' ').pop().toLowerCase()}">${f.situacion}</span></span></div>
      <div class="popup-row"><span class="popup-key">Dimensiones</span><span class="popup-val">${f.largo}√ó${f.ancho}m</span></div>
      <div class="popup-row"><span class="popup-key">Distancia camino</span><span class="popup-val">${f.distancia} ml</span></div>
      <div class="popup-row"><span class="popup-key">Volumen</span><span class="popup-val big">${f.m3.toLocaleString()} m¬≥</span></div>
    `;
  } else {
    const tipoConst = f.construccion_ml > 0 ? 'Construcci√≥n' : f.ensanche_ml > 0 ? 'Ensanche' : 'Bulldozer';
    rows = `
      <div class="popup-row"><span class="popup-key">Ancho</span><span class="popup-val">4.0 m</span></div>
      <div class="popup-row"><span class="popup-key">Construcci√≥n</span><span class="popup-val">${f.construccion_ml} ml</span></div>
      <div class="popup-row"><span class="popup-key">Ensanche</span><span class="popup-val">${f.ensanche_ml} ml</span></div>
      <div class="popup-row"><span class="popup-key">Bulldozer</span><span class="popup-val">${f.bulldozer_ml} ml</span></div>
      <div class="popup-row"><span class="popup-key">Total longitud</span><span class="popup-val">${f.total_ml} ml</span></div>
      <div class="popup-row"><span class="popup-key">Volumen Total</span><span class="popup-val big">${f.total_m3.toLocaleString()} m¬≥</span></div>
    `;
  }
  document.getElementById('popup-body').innerHTML = rows;

  // Position popup ‚Äî siempre dentro del √°rea visible
  const popupEl = document.getElementById('feature-popup');
  popupEl.style.visibility = 'hidden';
  popupEl.classList.add('visible');
  const popW = popupEl.offsetWidth || 240;
  const popH = popupEl.offsetHeight || 280;
  popupEl.classList.remove('visible');
  popupEl.style.visibility = '';

  const margin = 10;
  let px = screenX - rect.left + 14;
  let py = screenY - rect.top - popH / 2;

  // Si se sale por la derecha ‚Üí mostrar a la izquierda del punto
  if (px + popW + margin > rect.width) px = screenX - rect.left - popW - 14;
  // Si se sale por abajo ‚Üí subir
  if (py + popH + margin > rect.height) py = rect.height - popH - margin;
  // Si se sale por arriba ‚Üí bajar
  if (py < margin) py = margin;
  // Si se sale por la izquierda
  if (px < margin) px = margin;

  popupEl.style.left = px + 'px';
  popupEl.style.top = py + 'px';
  popupEl.classList.add('visible');
}
function closePopup() { document.getElementById('feature-popup').classList.remove('visible'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDataTable() {
  const tbody = document.getElementById('table-body');
  const canchas = state.datosData.canchas;
  tbody.innerHTML = canchas.map(c => `
    <tr onclick="highlightFeature('${c.tipo.replace(/\s/g,'')}_${c.camino}_${c.id_cancha}')">
      <td>${c.camino}</td>
      <td><strong>${c.id_cancha}</strong></td>
      <td><span class="tipo-badge tipo-${c.tipo.replace(/[\s.]/g,'')}">${c.largo}√ó${c.ancho}m</span></td>
      <td><span class="sit-badge sit-${c.situacion.split(' ').pop().toLowerCase()}">${c.situacion}</span></td>
      <td><strong>${c.m3.toLocaleString()}</strong></td>
    </tr>
  `).join('');
}

function updateCaminosTable() {
  const tbody = document.getElementById('caminos-body');
  const caminos = state.datosData.caminos.filter(c => c.total_m3 > 0);
  tbody.innerHTML = caminos.map(c => `
    <tr><td>C-${c.camino}</td><td>${c.construccion_ml}</td><td>${c.ensanche_ml}</td><td><strong>${c.total_m3.toLocaleString()}</strong></td></tr>
  `).join('');
}

function updateStats() {
  const canchas = state.datosData.canchas;
  const caminos = state.datosData.caminos.filter(c => c.total_m3 > 0);
  const totalM3 = canchas.reduce((s,c) => s + c.m3, 0) + caminos.reduce((s,c) => s + c.total_m3, 0);
  document.getElementById('st-caminos').textContent = caminos.length;
  document.getElementById('st-canchas').textContent = canchas.length;
  document.getElementById('st-m3').textContent = (totalM3/1000).toFixed(1) + 'k';
}

function filterData(tipo, btn) {
  state.filter = tipo;
  document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (state.geoData) renderMap();
}

function highlightFeature(id) {
  const f = state.features.find(x => x.id === id);
  if (f && f._cx) {
    // Center on feature
    const canvas = document.getElementById('map-canvas');
    state.panX += canvas.width/2 - f._cx;
    state.panY += canvas.height/2 - f._cy;
    renderMap();
    setTimeout(() => showPopup(f, f._cx, f._cy), 100);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function enableExport() {
  ['btn-geojson','btn-kml','btn-csv'].forEach(id => {
    document.getElementById(id).disabled = false;
  });
}

function exportarGeoJSON() {
  const geojson = {
    type: 'FeatureCollection',
    name: 'TROPEN_EFA_20023_C27',
    crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
    features: state.features.map(f => ({
      type: 'Feature',
      geometry: { type: 'Point', coordinates: [f.lng, f.lat] },
      properties: {
        id: f.id,
        tipo: f.tipo,
        label: f.label,
        camino: f.camino || '',
        id_cancha: f.id_cancha || '',
        situacion: f.situacion || '',
        m3: f.m3 || f.total_m3 || 0,
        largo: f.largo || '',
        ancho: f.ancho || '',
        distancia_ml: f.distancia || '',
        descripcion: buildDesc(f),
        marker_color: SIT_COLORS[f.situacion] || '#888',
        marker_symbol: f.tipo === 'TORRE' ? 'circle' : f.tipo === 'VIRADERO' ? 'square' : 'triangle',
      }
    }))
  };
  downloadFile('TROPEN_EFA_C27.geojson', JSON.stringify(geojson, null, 2), 'application/geo+json');
  log('GeoJSON exportado ‚úì', 'ok');
}

function exportarKML() {
  const placemarks = state.features.map(f => {
    const desc = buildDesc(f).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const color = (SIT_COLORS[f.situacion] || '#888').replace('#','');
    return `
  <Placemark>
    <name>${f.label}</name>
    <description><![CDATA[${buildDesc(f)}]]></description>
    <Style><IconStyle><color>ff${color.slice(4,6)}${color.slice(2,4)}${color.slice(0,2)}</color><scale>1.0</scale></IconStyle></Style>
    <Point><coordinates>${f.lng},${f.lat},0</coordinates></Point>
  </Placemark>`;
  }).join('\n');

  const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
  <name>TROPEN EFA [20023] - C27 - VE2027</name>
  <description>Bosques Arauco S.A. - Cubicaci√≥n de Caminos y Canchas</description>
${placemarks}
</Document>
</kml>`;
  downloadFile('TROPEN_EFA_C27.kml', kml, 'application/vnd.google-earth.kml+xml');
  log('KML exportado ‚úì', 'ok');
}

function exportarCSV() {
  const headers = ['Tipo','Camino','ID_Cancha','Situaci√≥n','Largo(m)','Ancho(m)','M3','Distancia_ml','Lat','Lng'];
  const rows = state.features.map(f => [
    f.tipo, f.camino || '', f.id_cancha || '', f.situacion || '',
    f.largo || '', f.ancho || '', f.m3 || f.total_m3 || 0,
    f.distancia || f.total_ml || '', f.lat, f.lng
  ].map(v => `"${v}"`).join(','));
  downloadFile('TROPEN_EFA_C27.csv', [headers.join(','), ...rows].join('\n'), 'text/csv;charset=utf-8;');
  log('CSV exportado ‚úì', 'ok');
}

function buildDesc(f) {
  if (f.type === 'cancha') {
    return `Cancha ${f.id_cancha} | ${f.tipo} | ${f.situacion} | ${f.largo}√ó${f.ancho}m | ${f.m3} m¬≥ | Camino ${f.camino} dist. ${f.distancia}ml`;
  }
  return `Camino ${f.camino} | ${f.construccion_ml}ml construcci√≥n | ${f.ensanche_ml}ml ensanche | Total: ${f.total_m3} m¬≥`;
}

function downloadFile(filename, content, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleGPS() {
  if (!navigator.geolocation) {
    alert('Tu dispositivo no soporta GPS.');
    return;
  }
  if (!state.gpsActive) {
    startGPS();
  } else {
    stopGPS();
  }
}

function startGPS() {
  state.gpsActive = true;
  const btns = ['gps-btn','gps-btn-always'];
  btns.forEach(id => {
    const b = document.getElementById(id);
    if (!b) return;
    b.style.background = '#1a73e8';
    b.style.color = '#fff';
    b.style.borderColor = '#1a73e8';
  });
  const bar = document.getElementById('gps-bar');
  const dot = document.getElementById('gps-dot');
  const status = document.getElementById('gps-status');
  bar.style.display = 'flex';
  dot.style.background = '#f39c12';
  status.textContent = 'Buscando se√±al GPS...';

  state.gpsWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      state.gpsLat = pos.coords.latitude;
      state.gpsLng = pos.coords.longitude;
      state.gpsAccuracy = pos.coords.accuracy;

      dot.style.background = '#27ae60';
      const acc = Math.round(pos.coords.accuracy);
      status.textContent = `GPS activo ¬∑ ¬±${acc}m`;

      // Show coords always, even without map
      const coordEl = document.getElementById('coord-display');
      if (coordEl) coordEl.textContent =
        `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)} ¬∑ ¬±${acc}m`;
      document.getElementById('map-info').style.display = 'block';

      // Show center button
      ['center-btn','center-btn-always'].forEach(id => {
        const b = document.getElementById(id);
        if (b) b.style.display = 'grid';
      });

      // Check bounds
      if (state.geoData) {
        const b = state.geoData.bounds;
        const inside = pos.coords.latitude >= b.minLat && pos.coords.latitude <= b.maxLat &&
                       pos.coords.longitude >= b.minLng && pos.coords.longitude <= b.maxLng;
        if (!inside) {
          dot.style.background = '#f39c12';
          status.textContent = `GPS activo ¬∑ fuera del predio ¬∑ ¬±${acc}m`;
        }
        renderMap();
      }
    },
    (err) => {
      const dot = document.getElementById('gps-dot');
      const status = document.getElementById('gps-status');
      dot.style.background = '#e74c3c';
      if (err.code === 1) {
        status.textContent = 'Permiso GPS denegado ‚Äî act√≠valo en Config. del navegador';
      } else if (err.code === 2) {
        status.textContent = 'Sin se√±al GPS ‚Äî mu√©vete a zona con cobertura';
      } else {
        status.textContent = 'Error GPS: ' + err.message;
      }
    },
    {
      enableHighAccuracy: true,
      maximumAge: 3000,
      timeout: 30000   // m√°s tiempo de espera en zonas con se√±al d√©bil
    }
  );
}

function stopGPS() {
  if (state.gpsWatchId !== null) {
    navigator.geolocation.clearWatch(state.gpsWatchId);
    state.gpsWatchId = null;
  }
  state.gpsActive = false;
  state.gpsLat = null;
  state.gpsLng = null;

  ['gps-btn','gps-btn-always'].forEach(id => {
    const b = document.getElementById(id);
    if (!b) return;
    b.style.background = '';
    b.style.color = '';
    b.style.borderColor = '';
  });
  ['center-btn','center-btn-always'].forEach(id => {
    const b = document.getElementById(id);
    if (b) b.style.display = 'none';
  });

  document.getElementById('gps-bar').style.display = 'none';
  const coordEl = document.getElementById('coord-display');
  if (coordEl) coordEl.textContent = 'UTM 18S ¬∑ TROPEN EFA [20023]';
  if (state.geoData) renderMap();
}

function centerOnGPS() {
  if (state.gpsLat === null || !state.geoData) return;
  const canvas = document.getElementById('map-canvas');
  const bounds = state.geoData.bounds;
  const imgH = state.geoData.canvas.height;
  const pdfW = bounds.pdfX2 - bounds.pdfX1;
  const pdfH = bounds.pdfY2 - bounds.pdfY1;
  const scl = state.geoData.scale;
  const nx = (state.gpsLng - bounds.minLng) / (bounds.maxLng - bounds.minLng);
  const ny = (state.gpsLat - bounds.minLat) / (bounds.maxLat - bounds.minLat);
  const pdfX = bounds.pdfX1 + nx * pdfW;
  const pdfY = bounds.pdfY1 + ny * pdfH;

  // Current feature position without pan
  const img = state.geoData.canvas;
  const baseSx = canvas.width / 2 - (img.width * state.zoom) / 2;
  const baseSy = canvas.height / 2 - (img.height * state.zoom) / 2;
  const gx = baseSx + state.panX + pdfX * scl * state.zoom;
  const gy = baseSy + state.panY + imgH * state.zoom - pdfY * scl * state.zoom;

  // Move pan so GPS dot is at center
  state.panX += canvas.width / 2 - gx;
  state.panY += canvas.height / 2 - gy;
  renderMap();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO ONLINE / OFFLINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function actualizarEstadoRed() {
  const offBadge = document.getElementById('offline-badge');
  const cacheBadge = document.getElementById('cache-badge');
  if (!navigator.onLine) {
    offBadge.style.display = 'inline';
    cacheBadge.style.display = 'none';
  } else {
    offBadge.style.display = 'none';
    if ('caches' in window) {
      caches.has('arauco-geomap-v1').then(tiene => {
        cacheBadge.style.display = tiene ? 'inline' : 'none';
      });
    }
  }
}

window.addEventListener('online', actualizarEstadoRed);
window.addEventListener('offline', actualizarEstadoRed);
window.addEventListener('load', () => {
  actualizarEstadoRed();
  setTimeout(actualizarEstadoRed, 3000);
});
</script>
</body>
</html>
